#!/bin/bash
shopt -s nocasematch
uname="$(uname|tr '[:upper:]' '[:lower:]')"
dir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

function create_folder {
    [ ! -d "$1" ] && mkdir -p "$1"
}

function die {
    echo "$*"
    echo 'Installation aborted.'
    exit 1
}

function has_installed {
    command -v "$1" &>/dev/null && return 0
    echo 1>&2 "$1 not installed, $2 ignored"
    return 1
}

function install_pacman {
    has_installed pacman "$1" || return
    has_installed sudo "$1" || return
    if pacman -Q "$1" >/dev/null; then
        echo "$1 already installed"
    else
        echo "Installing $1 with pacman..."
        sudo pacman -S "$1"
    fi
}

function install_cygwin {
    has_installed apt-cyg "$1" || return
    if apt-cyg list|grep "$1" >/dev/null; then
        echo "$1 already installed"
    else
        echo "Installing $1 with apt-cyg..."
        apt-cyg install "$1"
    fi
}

function install_pip {
    has_installed pip "$1" || return
    has_installed sudo "$1" || return
    if pip list|grep "$1" &>/dev/null; then
        echo "$1 already installed"
    else
        echo "Installing $1 with pip..."
        sudo pip install "$1"
    fi
}

function install_aur {
    url=https://aur.archlinux.org/packages/${1:0:2}/$1/$1.tar.gz
    has_installed pacman "$1" || return
    has_installed sudo "$1" || return
    has_installed wget "$1" || return
    has_installed tar "$1" || return
    if pacman -Q "$1" >/dev/null; then
        echo "$1 already installed"
    else
        pushd /tmp >/dev/null
        wget "$url" -qO- | tar xz || { echo "Package $1 not found!"; exit 1; }
        cd "$1"
        makepkg -i
        cd /tmp
        popd >/dev/null
    fi
}

function install_link {
    source=$1
    target=$2

    if [ -h "$target" ]; then
        echo -n 'Removing old symlink... '
        rm "$target"
    else
        [ -e "$target" ] && die "Not a symlink: $target."
    fi

    echo "Linking $source to $target..."
    create_folder $(dirname "$target")
    ln -s "$source" "$target"
}

function install_link_or_cp {
    source=$1
    target=$2

    if [[ "$uname" =~ cygwin ]]; then
        if [ -h "$target" ]; then
            echo -n 'Removing old symlink... '
            rm "$target"
        fi
        echo "Copying $source to $target..."
        cp "$source" "$target"
    else
        install_link "$source" "$target"
    fi
}

#basic stuff
    pushd $dir >/dev/null
    echo 'Updating git submodules...'
    git submodule init
    git submodule update
    popd >/dev/null

#cygwin
    if [[ "$uname" =~ cygwin ]]; then
        if ! command -v apt-cyg &>/dev/null; then
            echo Installing apt-cyg...
            lynx -source rawgit.com/transcode-open/apt-cyg/master/apt-cyg > apt-cyg
            install apt-cyg /bin
        fi
    fi

#networking
    install_cygwin wget
    install_cygwin curl
    install_pacman wget #required for install_aur
    install_pacman curl
    install_pacman openssh

#fonts
    install_pacman ttf-dejavu
    install_aur ttf-font-awesome
    install_aur ttf-ipa-mona
    if [ -d /usr/share/fonts ]; then
        fonts_dir="$HOME/.local/share/fonts"
        [ -d "$fonts_dir" ] || mkdir -p "$fonts_dir"
        find "$dir/misc" -iregex '.*\.\(ttf\|otf\|pcf\|bdf\)' | while read -r x; do
            install_link "$x" "$fonts_dir/$(basename "$x")"
        done
        mkfontscale "$fonts_dir"
        mkfontdir "$fonts_dir"
        xset +fp "$fonts_dir"
        xset fp rehash
    fi
    if has_installed fc-list 'font config'; then
        install_link "$dir/.config/fontconfig" "$HOME/.config/fontconfig"
        fc-cache
    fi

#python
    install_cygwin python
    install_cygwin python3
    install_pacman python
    install_pacman python-pip

#i3
    if [[ "$uname" =~ linux ]]; then
        install_pacman feh
        install_aur xcb-util-cursor-git
        install_aur i3-gaps-next-git
        if has_installed i3 'i3 config'; then
            install_link "$dir/ext/i3-floater/i3-floater" "$dir/bin/ext/i3-floater"
            install_link "$dir/.config/i3" "$HOME/.config/i3"
            install_link "$dir/.config/i3status" "$HOME/.config/i3status"
        fi
    fi

#bspwm
    if [[ "$uname" =~ linux ]]; then
        install_aur bspwm-git
        install_aur sxhkd-git
        install_aur lemonbar-xft-git
        install_pip psutil      #CPU usage
        install_pip pyalsaaudio #volume
        install_pip python-mpd2 #mpd interaction
        if has_installed bspwm 'bspwm config'; then
            install_link "$dir/.config/bspwm" "$HOME/.config/bspwm"
            install_link "$dir/.config/sxhkd" "$HOME/.config/sxhkd"
        fi
    fi

#git
    install_cygwin git
    install_pacman git
    install_link "$dir/.gitconfig" "$HOME/.gitconfig"
    install_link "$dir/.gitignore" "$HOME/.gitignore"

#vim
    install_cygwin vim
    install_pacman gvim
    if has_installed vim 'vim config'; then
        create_folder "$HOME/.vim/undo"
        create_folder "$HOME/.vim/backup"
        create_folder "$HOME/.vim/swap"
        create_folder "$HOME/.vim/spell"
        install_link "$dir/.vim/spell/pl.utf-8.add" "$HOME/.vim/spell/pl.utf-8.add"
        install_link "$dir/.vim/spell/en.utf-8.add" "$HOME/.vim/spell/en.utf-8.add"
        install_link "$dir/.vim/vundle" "$HOME/.vim/vundle"
        install_link "$dir/.vimrc" "$HOME/.vimrc"
    fi

#zsh
    install_cygwin zsh
    install_pacman zsh
    if has_installed zsh 'zsh config'; then
        install_link "$dir/.zlogin" "$HOME/.zlogin"
        install_link "$dir/.zshrc" "$HOME/.zshrc"
    fi

#x
    if [[ "$uname" =~ linux ]]; then
        install_aur escrotum-git
        install_pacman xdotool
        install_pacman autocutsel #synchronize primary and selection clipboards
        install_pacman clipit #keep clipboard content even after application closes
        if has_installed Xorg 'x init script'; then
            install_link "$dir/.xinitrc" "$HOME/.xinitrc"
        fi
        install_pacman libconfig #for compton
        install_pacman xorg-xprop #for compton-trans
        install_pacman xorg-xwininfo #for compton-trans
        install_aur compton
        if has_installed compton 'compton config'; then
            install_link "$dir/.config/compton.conf" "$HOME/.config/compton.conf"
        fi
    fi

#development
    install_cygwin make
    install_cygwin gcc
    install_cygwin automake
    install_pacman make
    install_pacman gcc
    install_pacman automake

    #visual studio
        if has_installed devenv 'visual studio config'; then
            install_link_or_cp "$dir/.vimrc" "$HOME/.vsvimrc"
        fi

#firefox
    if has_installed firefox 'vimperator config'; then
        install_link_or_cp "$dir/.vimperatorrc" "$HOME/.vimperatorrc"
    fi

#terminal emulators
    install_pacman rxvt-unicode
    if has_installed urxvt 'urxvt config'; then
        install_link "$dir/.config/Xresources" "$HOME/.config/Xresources"
        install_link "$dir/.config/Xresources-light" "$HOME/.config/Xresources-light"
        install_link "$dir/.config/Xresources-dark" "$HOME/.config/Xresources-dark"
    fi
    if has_installed mintty 'mintty config'; then
        install_link "$dir/.inputrc" "$HOME/.inputrc"
        install_link "$dir/.minttyrc-light" "$HOME/.minttyrc"
    fi

#mpv
    install_pacman mpv
    if has_installed mpv 'mpv config'; then
        install_link "$dir/.config/mpv" "$HOME/.config/mpv"
    fi

#eyecandy
    install_link "$dir/ext/eyecandy/eyecandy" "$dir/bin/ext/eyecandy"
    if has_installed eyecandy 'eyecandy config'; then
        install_link "$dir/.config/EyeCandy" "$HOME/.config/EyeCandy"
    fi

#music player
    install_pacman mpd
    install_pacman mpc
    if has_installed mpd 'mpd config'; then
        install_link "$dir/.config/mpd" "$HOME/.config/mpd"
        create_folder "$HOME/.config/mpd/playlists"
        touch "$HOME/.config/mpd/"{database,log,pid,state,sticker.sql}
    fi
    #install_pacman cmus
    #if has_installed cmus 'cmus config'; then
    #    install_link "$dir/.config/cmus" "$HOME/.config/cmus"
    #fi

#trackma
    if [[ "$uname" =~ linux ]]; then
        install_pacman lsof
        install_aur trackma-git
    fi

#htop
    install_cygwin htop
    install_pacman htop
    if has_installed htop 'htop config'; then
        install_link "$dir/.config/htop" "$HOME/.config/htop"
    fi

#translator
    install_link "$dir/ext/translator/tl" "$dir/bin/ext/tl"

#thunar
    install_pacman thunar
    if command -v xfconf-query &>/dev/null; then
        #enable full path in thunar window title for scripting
        xfconf-query --channel thunar --property /misc-full-path-in-title --create --type bool --set true
    fi

#windows
    if [[ "$uname" =~ cygwin ]]; then
        echo "Hiding dotfiles in $HOME..."
        find "$HOME" -maxdepth 1 -iname '.*' | while read -r x; do
            attrib +h +s $(cygpath -w `dirname "$x"`)/`basename "$x"`
        done
    fi
